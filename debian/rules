#!/usr/bin/make -f

# debian/rules file for the ACE Debian GNU/Linux package
# written February 2002 by Ossama Othman <ossama@debian.org>
# Modified August 2003 by Brian Nelson <pyro@debian.org>
# Copyright (C) 2004  Raphael Bossek <bossekr@debian.org>
# Modified 2005, 2006, 2007 by Thomas Girard <thomas.g.girard@free.fr>

INSTALL := install
export AV := 5.5.6
export TV := 1.5.6
export CV := 0.5.6

export DEB_HOST_GNU_TYPE ?= $(shell dpkg-architecture -qDEB_HOST_GNU_TYPE)
export DEB_BUILD_GNU_TYPE ?= $(shell dpkg-architecture -qDEB_BUILD_GNU_TYPE)

ifeq ($(DEB_BUILD_GNU_TYPE),$(DEB_HOST_GNU_TYPE))
confflags += --build $(DEB_HOST_GNU_TYPE)
else
confflags += --build $(DEB_BUILD_GNU_TYPE) \
             --host $(DEB_HOST_GNU_TYPE)
endif

TCL_HOME := /usr/lib/tcl8.4
TK_HOME  := /usr/lib/tk8.4

ACE_SUBDIR := ACE_wrappers
ACE_ARCHIVE := $(shell ls -1 ACE+TAO+CIAO*.tar.bz2 2>/dev/null || echo ace-archive-missing)
MPC_SUBDIR := MPC
MPC_ARCHIVE := $(shell ls -1 MPC*.tar.gz 2>/dev/null || echo mpc-archive-missing)

MAN1 := debian/Basic_Logging_Service.1 \
	debian/Event_Logging_Service.1 \
	debian/Notify_Logging_Service.1 \
	debian/RTEvent_Logging_Service.1 \
	debian/TAO_ORB_Options.1 \
	debian/mpc-ace.1
MAN5 :=

ifneq (mpc-archive-missing,$(MPC_ARCHIVE))
export MPC_ROOT := $(shell pwd)/$(MPC_SUBDIR)
endif
export ACE_ROOT := $(shell pwd)/$(ACE_SUBDIR)
export TAO_ROOT := $(ACE_ROOT)/TAO
export LD_LIBRARY_PATH := $(LD_LIBRARY_PATH):$(ACE_ROOT)/lib
export QTDIR := /usr/share/qt3

# This is the debhelper compatibility version to use.
export DH_COMPAT=5

extract: $(ACE_ARCHIVE)
	tar -xjf $<
	touch $@

$(MPC_ROOT): $(MPC_ARCHIVE)
	tar -xzf $<
	touch $@

debian/mpc-ace.sgml: debian/mpc.sgml
	sed -e 's/mpc\.pl/mpc-ace/g' -e 's/mwc\.pl/mwc-ace/g' $< > $@

debian/%.1 debian/%.5: debian/%.sgml
	docbook-to-man $< > $@

patch-pl: extract
	for fn in `find "$(ACE_ROOT)" -name "*.pl"`; do (echo '#!/usr/bin/perl'; cat "$$fn") > "$${fn}T"; mv "$${fn}T" "$$fn"; chmod a+x "$$fn"; done
	touch $@

unpatch: clean extract

# TODO: DEB_BUILD_OPTIONS broken now

build: build-stamp build-manpages

build-manpages: $(MAN1) $(MAN5)
	touch $@

build-stamp: configure-stamp
	dh_testdir

	# Hack to remove once the bug is fixed
	mkdir -p objdir/ace/QtReactor
	$(MAKE) -C objdir

	# $(MAKE) -C $(TAO_ROOT)/CIAO

	touch $@

clean:
	dh_testdir
	rm -rf *.tmp $(ACE_SUBDIR) $(MPC_SUBDIR) objdir debian/patched $(MAN1) $(MAN5) patch-pl patch extract debian/mpc-ace.sgml build-manpages build-stamp

	dh_clean

install: build
	dh_testdir
	dh_testroot
	dh_clean -k
	dh_installdirs

	$(MAKE) -C objdir install DESTDIR=$(CURDIR)/debian/tmp

	mv $(CURDIR)/debian/tmp/usr/bin/gperf $(CURDIR)/debian/tmp/usr/bin/gperf-ace

	sed -e 's/gperf/gperf-ace/g' \
            -e 's/GPERF/GPERF-ACE/g' \
           $(ACE_ROOT)/apps/gperf/gperf.1 > \
	   $(ACE_ROOT)/apps/gperf/gperf-ace.1
	sed -e 's/gperf\.info/gperf-ace\.info/g' \
            -e 's/(gperf)\.    /(gperf-ace)\./g' \
           $(ACE_ROOT)/apps/gperf/gperf.info > \
           $(ACE_ROOT)/apps/gperf/gperf-ace.info

#	Rename the catior utility, it already exists in another package
	mv $(CURDIR)/debian/tmp/usr/bin/catior $(CURDIR)/debian/tmp/usr/bin/tao-catior

#       Multiple README
	cp $(TAO_ROOT)/utils/catior/README $(TAO_ROOT)/utils/catior/README.catior
	cp $(TAO_ROOT)/utils/nslist/README $(TAO_ROOT)/utils/nslist/README.nslist

#	Rename tao_idl to have a script automatically define ACE_ROOT and
#	TAO_ROOT
	mv $(CURDIR)/debian/tmp/usr/bin/tao_idl $(CURDIR)/debian/tmp/usr/bin/tao_idl.real
	$(INSTALL) -m 755 -o root -g root -D debian/tao_idl debian/tao-idl/usr/bin/tao_idl
	mv  $(CURDIR)/debian/tmp/usr/bin/tao_ifr  $(CURDIR)/debian/tmp/usr/bin/tao_ifr.real
	$(INSTALL) -m 755 -o root -g root -D debian/tao_ifr debian/tao-ifr/usr/bin/tao_ifr

#       Rename mpc.pl and mwc.pl so that they do not include language extension.
	cp $(ACE_ROOT)/bin/mpc.pl $(ACE_ROOT)/bin/mpc-ace
	cp $(ACE_ROOT)/bin/mwc.pl $(ACE_ROOT)/bin/mwc-ace

#	Be lintian clean, fix permissions on examples
	-chmod -x `find $(TAO_ROOT)/examples/ -perm 755 ! -type d -a ! \( -name "*.pl" -o -name "*.sh" \)`
	-chmod -x `find $(TAO_ROOT)/CIAO/examples/ -perm 755 ! -type d -a ! \( -name "*.pl" -o -name "*.sh" \)`
#	And on some header files
	-chmod -x `find $(TAO_ROOT)/orbsvcs -perm 755 ! -type d -a \( -name "*.h" -o -name "*.inl" -o -name "*.i" \)`

	dh_install --sourcedir=debian/tmp

#	Fix duplicate files within reactor packages and main packages
	sh debian/remove_reactor_dups.sh

binary-indep: build install
	dh_testdir -i
	dh_testroot -i
	dh_installdocs -i
	dh_installexamples -i
	dh_installman -i
	dh_installchangelogs -i $(ACE_ROOT)/ChangeLog
	dh_perl -i
	dh_link -i
	dh_compress -i -Xexamples -Xtutorials
	dh_fixperms -i
	dh_installdeb -i
	dh_gencontrol -i
	dh_md5sums -i
	dh_builddeb -i

binary-arch: build install
	dh_testdir -a
	dh_testroot -a
	dh_installdocs -a -A
	dh_installman -a
	dh_installinfo -pgperf-ace $(ACE_ROOT)/apps/gperf/gperf-ace.info
	dh_installchangelogs -a $(ACE_ROOT)/ChangeLog
	dh_installchangelogs -pgperf-ace $(ACE_ROOT)/apps/gperf/ChangeLog
	dh_strip -a
	dh_link -a
	dh_compress -a
	dh_fixperms -a
	dh_makeshlibs -a -V
	dh_installdeb -a
	dh_shlibdeps -a -l `ls -1 debian/lib*c2a.install | sed -e 's#\(.*\)\.install#\1/usr/lib#' | tr '\n' ':' | sed -e 's#:$$##'`
	dh_gencontrol -a
	dh_md5sums -a
	dh_builddeb -a

source diff:
	@echo >&2 'source and diff are obsolete - use dpkg-source -b'; false

binary: binary-indep binary-arch

bootstrap: extract
	cd $(ACE_ROOT) && bin/bootstrap

configure-stamp: extract $(ACE_ROOT)/configure
	mkdir -p objdir
	cd objdir && ../ACE_wrappers/configure $(confflags) --prefix=/usr --disable-tao-examples --disable-tao-tests --disable-ace-examples --disable-ace-tests --enable-fl-reactor --enable-qt-reactor --enable-tk-reactor  --enable-xt-reactor --enable-symbol-visibility --with-tclconfig=$(TCL_HOME) --with-tkconfig=$(TK_HOME)
	touch $@

.PHONY: build clean binary-indep binary-arch binary install unpatch prepatch prepatchtwo update-makefile update-makefile-complete source diff dpatch bootstrap
